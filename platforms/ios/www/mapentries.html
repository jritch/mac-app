<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <![endif]-->

 <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Age-CAP</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrapresponsive.min.css">
        <link rel="stylesheet" href="css/map.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/spinner.css">
        <script src="js/vendor/modernizr262respond110min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->

<!-- ==========================================================================
   Navbar Code
   ========================================================================== -->

        <div class="navbar navbar-fixed-top">
          <div class="navbar-inner">

            <div class="container-fluid" id="header-container">
            
              <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <div id="back-btn"> <button class="btn btn-primary" onClick="history.go(-1);return true;">BACK</button> </div>
              <a id="page-title" class="brand">View Results</a>

              <div class="nav-collapse collapse">
                <ul class="nav">
                  <li><a href="index.html">Home <span class="icon-home"></span></a></li>
                  

                  <li> <a id="font-button">Change Font Size  <span class="icon-font"></span></a></li>
                  <li> <a href="feedback.html" id="feedback-button">Give Feedback  <span class="icon-thumbs-up"></span></a></li>
                  <li> <a href="#myModal" data-toggle="modal">About Age-CAP</a></li>
                </ul>
              </div><!--/.nav-collapse -->

            </div>
          </div>
        </div>

<!-- ==========================================================================
   End Navbar Code
   ========================================================================== -->
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span8 offset2 question_background">
                  <h4 id="headline" style="text-decoration:underline">Viewing Locations</h4>
              <div class="btn-group">
                <button class="btn btn-primary">Options</button>
                <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a href="resultslistfromtemplate.html">Alter Search Settings</a></li> 
                    <li><a href="selectlandingread.html">Choose a New Starting Point</a></li>
                    <li><a href="entrieslistfromtemplate.html" style="margin-left:auto; margin-right:auto;">View Results as Text</a></li>
                </ul>
                </div>
              </div>
            </div>
            <div class="spacer10"></div>
            <div class="row-fluid">
                <div id="mapcontainer" class="span8 offset2 question_background">
                <div id="map"></div>  
                </div>
            </div>
        </div>

<!-- ==========================================================================
  Modal Code
   ========================================================================== -->

        <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">  
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            <h3 id="myModalLabel">About Age-CAP</h3>
          </div>
          <div class="modal-body">
            <p style=\'text-align:justify\'>Age-CAP is a smartphone application which aims to create a crowd-sourced database of age-friendly locations. It consists of survey styled forms which enable users to quickly rate a location. Users are also able to browse this database to assess the age-friendliness of locations in their neighborhood, providing them access to information which was otherwise unavailable. <br><br>Age-CAP was created by a multi-disciplinary team from the Toronto Rehabilitation Institute, University Health Network and University of Toronto.<br><br>Feedback or questions: iatsl@utoronto.ca</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
          </div>
        </div>
<!-- ==========================================================================
   End Modal Code
   ========================================================================== -->

      <!-- ==========================================================================
  Loading Code
   ========================================================================== -->

        <div id="loadingModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">  
          <div class="modal-body" style="text-align:center; margin-right:auto; margin-left:auto;">
              <div id="floatingCirclesG">
              <div class="f_circleG" id="frotateG_01">
              </div>
              <div class="f_circleG" id="frotateG_02">
              </div>
              <div class="f_circleG" id="frotateG_03">
              </div>
              <div class="f_circleG" id="frotateG_04">
              </div>
              <div class="f_circleG" id="frotateG_05">
              </div>
              <div class="f_circleG" id="frotateG_06">
              </div>
              <div class="f_circleG" id="frotateG_07">
              </div>
              <div class="f_circleG" id="frotateG_08">
              </div>
              </div> 
            <h4>Loading...</h4>
          </div>
        </div>
<!-- ==========================================================================
   End Loading Code
   ========================================================================== -->

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/vendor/jquery191min.js"><\/script>')</script> <!--- failsafe to load up jQuery if the online copy is unavailable-->
    <script src="js/vendor/bootstrap.min.js"></script>
    
    <script src="js/main.js"></script>
    <script src="js/map.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="js/bounding.js"></script>

<script>
    
$('#loadingModal').modal('show');

var pinImageRed = getPinImage("FE7569");
var pinImageGreen = getPinImage("50C264");
var pinShadow = getPinShadow();
var resultsArray= new Array(); var markerArray = new Array();
var i;
var activeWindow;

function getEntries(){

  coords = JSON.parse(localStorage.getItem("starting_coords")); 
  radius = localStorage.getItem("radius");

  if (radius != "all") radius = Number(radius);

  table = localStorage.getItem("typeToView");
  names = JSON.parse(localStorage.getItem("names"));
  name = names[table]

  if(radius != "all") message = "Viewing " + name + " Locations within " + radius + " kilometers";
  else message = "Viewing " + name + " Locations Worldwide";

  $("#headline").html(message);

//I don't like duplicating code, but doing this over again is actually faster than storing 
//the dataArray object using the localStorage object, for some reason
//...should turn this code into a function call at some point

  if (radius == "all")
  {
    dataArray={table:table, infiniteRadius:1};
  }
  else
  {
    var boundingArray = boundingCoordinates(radius, 6371, coords["lat"], coords["lng"]);
    var dataArray = {table:table, minLat:boundingArray["minLat"], maxLat:boundingArray["maxLat"], minLng:boundingArray["minLon"], maxLng:boundingArray["maxLon"]}
  }
    

  $.ajax({type:'POST', 
    url:'http://142.150.169.179/map_entries.php', 
    dataType: 'json', 
    data:dataArray, 
    success: function(data){populateMap(data);}, 
    error:function(data){resultsArray = data; $('#map').html(data.responseText);}});


  function populateMap(data){

    resultsArray  = data; 

    var latlng = new google.maps.LatLng(coords["lat"], coords["lng"]);

    var mapOptions = {
        zoom: 11,
        center: latlng,
        zoomControl: true,
        mapTypeControl: false,
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.SMALL
        } 
    };

    if (radius=="all") {
      mapOptions["zoom"] = 2;
      mapOptions["center"] = new google.maps.LatLng(20,-85);
    }

    var manasmap = new google.maps.Map(document.getElementById("map"), mapOptions);

    google.maps.event.addListenerOnce(manasmap, 'idle', function(){
     $('#loadingModal').modal('hide');
      });
  
    function listenMarker (mark, i)
      {
        
        google.maps.event.addListener(mark, 'click', function(e) {

          if (activeWindow) activeWindow.close();

          localStorage.setItem("nameToView", resultsArray[0][i]);
          localStorage.setItem("postalCodeToView", resultsArray[4][i]);
          localStorage.setItem("tableToView", resultsArray[5][i]);
          
          mark.infowindow = new google.maps.InfoWindow();
          mark.infowindow.setContent( resultsArray[0][i] + ' <br>Average rating: ' + resultsArray[3][i] +  '<br><a href="viewratingfromtemplate.html" style="float:right">View rating>></a>'); 
          mark.infowindow.open(manasmap,mark);
          activeWindow = mark.infowindow;

        });
        
      } 
          
    for (i=0;i<resultsArray[0].length;i++){
        var currentLatitude = resultsArray[1][i];
        var currentLongitude =resultsArray[2][i];
        
        var latlng_m = new google.maps.LatLng(currentLatitude, currentLongitude);
        
        markerOptions = {
                          position: latlng_m,
                          map: manasmap,
                          title: resultsArray[0][i],
                          shadow: pinShadow,
                          icon: pinImageGreen
                        }

        if(Number(resultsArray[3][i]) < 3.0) markerOptions["icon"] = pinImageRed;

        markerArray[i] = new google.maps.Marker(markerOptions);

      mark = markerArray[i];
      listenMarker(mark,i); 
      }    
    }//This is the end of populateMap func.
}

getEntries(); 

</script>
    </body>
</html>